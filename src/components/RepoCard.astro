---
import { Image } from 'astro:assets';
import { Icon } from 'astro-icon';
import fallbackImage from '../assets/previews/minimal.webp';
import type { Example } from '../data/examples.js';
import CopyButton from './CopyButton.astro';
import RepoCardLink from './RepoCardLink.astro';

export type Props = Example & { aboveTheFold: boolean };

const {
	title,
	sourceUrl,
	idxUrl,
	stackblitzUrl,
	codesandboxUrl,
	gitpodUrl,
	previewUrl,
	createAstroTemplate,
	loadPreviewImage = () => fallbackImage,
	aboveTheFold,
} = Astro.props;

const image = await loadPreviewImage();
const headingId = `template-${createAstroTemplate}`;
---

<article
	class="relative bg-astro-gray-600 outline outline-1 -outline-offset-1 outline-astro-gray-100/10"
	aria-labelledby={headingId}
>
	<div class="noise z-0"></div>
	<div class="aspect-video bg-astro-gray-700">
		<Image
			src={image}
			alt=""
			loading={aboveTheFold ? 'eager' : 'lazy'}
			widths={[400, 600, 900]}
			sizes="(min-width 1280px) 390px,(min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw"
			class="object-cover object-left-top s-full"
		/>
	</div>
	<div class="flex flex-col gap-4 p-5">
		<h2 class="heading-4" id={headingId}>{title}</h2>
		<p class="flex flex-wrap gap-2">
			{
				previewUrl && (
					<RepoCardLink as="a" href={previewUrl} icon="eye">
						Preview
					</RepoCardLink>
				)
			}
			<RepoCardLink as="a" href={sourceUrl} icon="github">Source code</RepoCardLink>
			<CopyButton {createAstroTemplate} />
		</p>
		<hr class="border-astro-gray-100/10" />
		<div
			class="relative flex h-10 w-max min-w-0 max-w-full divide-x divide-astro-gray-600 rounded-full bg-blue-purple-gradient"
		>
			<a
				href={idxUrl}
				target="_blank"
				rel="noopener noreferrer"
				class="flex items-center gap-2 rounded-l-full bg-black/15 px-4 text-sm transition hover:backdrop-brightness-75"
			>
				<Icon name="idx" size={16} aria-hidden="true" /> Open in IDX
			</a>
			<details class="z-10" data-card-options>
				<summary
					class="flex h-full cursor-pointer list-none items-center rounded-r-full bg-black/15 px-2 transition hover:backdrop-brightness-75"
				>
					<span class="sr-only">More options</span>
					<Icon name="chevron-down" size={20} aria-hidden="true" />
				</summary>
				<ul
					class="absolute left-0 top-full mt-2 flex w-max flex-col rounded bg-white p-2 text-astro-gray-700 shadow-md"
				>
					<li>
						<a
							href={stackblitzUrl}
							class="flex flex-row items-center gap-2 rounded-sm px-3 py-2 hover:bg-blue-purple-gradient hover:text-white"
						>
							<Icon name="stackblitz" size={20} aria-hidden="true" /> Open in StackBlitz
						</a>
					</li>
					<li>
						<a
							href={gitpodUrl}
							class="flex flex-row items-center gap-2 rounded-sm px-3 py-2 hover:bg-blue-purple-gradient hover:text-white"
						>
							<Icon name="gitpod" size={20} aria-hidden="true" /> Open in Gitpod
						</a>
					</li>
					<li>
						<a
							href={codesandboxUrl}
							class="flex flex-row items-center gap-2 rounded-sm px-3 py-1.5 hover:bg-blue-purple-gradient hover:text-white"
						>
							<Icon name="codesandbox" size={20} aria-hidden="true" /> Open in CodeSandbox
						</a>
					</li>
				</ul>
			</details>
		</div>
	</div>
</article>

<script>
	const dropdowns = document.querySelectorAll<HTMLDetailsElement>('details[data-card-options]');

	window.addEventListener('click', (event) => {
		for (const dropdown of dropdowns) {
			if (dropdown.open && !dropdown.contains(event.target as Node)) {
				dropdown.open = false;
			}
		}
	});

	for (const dropdown of dropdowns) {
		const summary = dropdown.querySelector('summary') as HTMLElement;
		const focusableItems = dropdown.querySelectorAll<HTMLElement>('a, button');

		dropdown.addEventListener('keydown', (event) => {
			const previouslyHadFocus = dropdown.contains(document.activeElement);
			if (event.key === 'Escape') {
				dropdown.open = !dropdown.open;
				if (previouslyHadFocus) {
					summary.focus();
				}
			}
		});

		dropdown.addEventListener('keydown', (event) => {
			const currentIndex = Array.from(focusableItems).indexOf(
				document.activeElement as HTMLElement,
			);

			const modLooped = (n: number, m: number) => ((n % m) + m) % m;

			if (event.key === 'ArrowDown') {
				event.preventDefault();
				focusableItems[modLooped(currentIndex + 1, focusableItems.length)]?.focus();
			}
			if (event.key === 'ArrowUp') {
				event.preventDefault();
				focusableItems[modLooped(currentIndex - 1, focusableItems.length)]?.focus();
			}
		});

		summary.addEventListener('keydown', (event) => {
			if (event.key === 'ArrowDown') {
				event.preventDefault();
				event.stopPropagation();
				dropdown.open = true;
				focusableItems[0]?.focus();
			}
			if (event.key === 'ArrowUp') {
				event.preventDefault();
				event.stopPropagation();
				dropdown.open = true;
				focusableItems[focusableItems.length - 1]?.focus();
			}
		});

		for (const item of focusableItems) {
			item.addEventListener('blur', (event) => {
				if (!dropdown.contains(event.relatedTarget as Node) || event.relatedTarget === summary) {
					dropdown.open = false;
				}
			});
		}
	}
</script>

<style>
	details summary::-webkit-details-marker {
		display: none;
	}
</style>
